<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="/socket.io/socket.io.js"></script>
<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
  }
  .board {
    display: grid;
    grid-template-columns: repeat(3, 100px);
    gap: 5px;
    margin-top: 20px;
  }
  .cell {
    width: 100px;
    height: 100px;
    background-color: lightgray;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
  }
  .cell :hover {
    background-color: aqua;
  }
  .win {
    background: lightgreen;
  }
  .btn {
    background: lightyellow;
    margin-top: 10px;
    border: 1px solid black;
    border-radius: 3px;
  }
</style>
<title>Grid Duel</title>
</head>
<body>
  <h1>Grid Duel</h1>
  <p>Player Turn: <span id="currentPlayer">X</span></p>
  <div class="board" id="board">
    <div class="cell one 1" onclick="selectCell(this)">X</div>
    <div class="cell two 2" onclick="selectCell(this)">X</div>
    <div class="cell three 3" onclick="selectCell(this)">X</div>
    <div class="cell four 4" onclick="selectCell(this)"></div>
    <div class="cell five 5" onclick="selectCell(this)"></div>
    <div class="cell six  6" onclick="selectCell(this)"></div>
    <div class="cell seven 7" onclick="selectCell(this)">Y</div>
    <div class="cell eight 8" onclick="selectCell(this)">Y</div>
    <div class="cell nine 9" onclick="selectCell(this)">Y</div>
  </div>
  <p id="winMessage" style="display: none;"></p>
  <button class="reset btn" onclick="resetGame(this)">Reset</button>
  <script>

    let socket = io()
   
    let selectedCell = null;
    let currentPlayer = 'X';
    //initial game state
    let state = {
      'one':'X', 'two': 'X', 'three': 'X', 
      'four': '', 'five': '', 'six': '',
      'seven': 'Y', 'eight': 'Y', 'nine': 'Y',
    };

    socket.on('move', (data)=> {
      state = data.state
      currentPlayer = data.currentPlayer
      
      updateGameState(state)
      updateCurrentPlayer(currentPlayer)
      checkWin()
    })


    // player moves implementation
    function selectCell(cell) {
      if (!selectedCell) {
        if (cell.textContent !== "" && cell.textContent === currentPlayer) {
          selectedCell = cell;
        }
      } else if (cell.textContent === "" && isAdjacent(selectedCell, cell)) {
        cell.textContent = selectedCell.textContent;
        selectedCell.textContent = "";
        selectedCell = null;
        currentPlayer = (currentPlayer === 'X') ? 'Y' : 'X';

        updateCurrentPlayer(currentPlayer)        
        updateState();

        // emit game state to the other player
        let data = { state, currentPlayer}
        socket.emit('move', data)
        checkWin();

      }
    }

    function isAdjacent(cell1, cell2) {
      const cell1Index = Array.from(document.querySelectorAll('.cell')).indexOf(cell1);
      const cell2Index = Array.from(document.querySelectorAll('.cell')).indexOf(cell2);
      const rowIndexDiff = Math.abs(Math.floor(cell1Index / 3) - Math.floor(cell2Index / 3));
      const colIndexDiff = Math.abs(cell1Index % 3 - cell2Index % 3);
      return rowIndexDiff <= 1 && colIndexDiff <= 1;
    }

    // manage game state
    function updateState() {
      document.querySelectorAll('.cell').forEach(cell => {
        const cellIndex = cell.classList[1];
        state[cellIndex] = cell.textContent;
      });
    }

    function updateGameState(state){
      document.querySelectorAll('.cell').forEach(cell => {
        let cellIndex = cell.classList[1]
        cell.textContent = state[cellIndex]
      })
    }

    function updateCurrentPlayer(currentPlayer){
      document.getElementById('currentPlayer').textContent = currentPlayer;

    }

    function checkWin() {
      const winPatterns = [
        ['four', 'five', 'six'], //Rows
        ['one', 'four', 'seven'], ['two', 'five', 'eight'], ['three','six', 'nine' ], //Columns
        ['one', 'five', 'nine'], ['three', 'five', 'seven'] // Diagonals
        
      ];
      for (const pattern of winPatterns) {
        const [a, b, c] = pattern;
        if (state[a] && state[a] === state[b] && state[a] === state[c]) {
          document.getElementById('winMessage').textContent = `Player ${state[a]} wins!`;
          document.getElementById('winMessage').style.display = 'block';

          showWinningCells([a, b, c])
        }
      }
    }

    function showWinningCells(cells){
      cells.forEach( cell => {
          document.querySelector(`.${cell}`).style.background = 'lightgreen'
      })
    }

    //reset game to initial state
    function resetGame(){
      currentPlayer = 'X';
      state = {
      'one':'X', 'two': 'X', 'three': 'X', 
      'four': '', 'five': '', 'six': '',
      'seven': 'Y', 'eight': 'Y', 'nine': 'Y',
    };

    document.querySelectorAll('.cell').forEach(cell => {
      cell.style.background = ''
    })
    document.getElementById('winMessage').style.display = 'none';

    updateGameState(state)
    updateCurrentPlayer(currentPlayer)

    }

  </script>
</body>
</html>
